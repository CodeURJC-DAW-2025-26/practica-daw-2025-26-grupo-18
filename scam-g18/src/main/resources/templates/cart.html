{{>header}}

        <main class="main">
            <!-- Page Title -->
            <div class="page-title light-background">
                <div class="container">
                    <nav class="breadcrumbs">
                        <ol>
                            <li><a href="/">Inicio</a></li>
                            <li class="current">Carrito</li>
                        </ol>
                    </nav>
                    <h1>Carrito de Compra</h1>
                </div>
            </div>
            <!-- End Page Title -->

            <!-- Cart Section -->
            <section id="cart-section" class="section">
                <div class="container" data-aos="fade-up">
                    {{#errorNoSeats}}
                    <div class="alert alert-danger" role="alert">
                        No se ha podido completar la compra porque uno de los eventos ya no tiene plazas disponibles.
                    </div>
                    {{/errorNoSeats}}
                    <!-- Back Button -->
                    <div class="mb-4">
                        <a href="/" class="btn btn-secondary d-inline-flex align-items-center gap-2" style="background-color: #85613d; border-color: #85613d"> <i class="bi bi-arrow-left"></i> Volver </a>
                    </div>

                    <div class="row">
                        <div class="col-lg-8">
                            <!-- Cart Items -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0">Tu Pedido</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col">Producto</th>
                                                    <th scope="col">Cantidad</th>
                                                    <th scope="col" class="text-end">Precio</th>
                                                    <th scope="col" class="text-end">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{#order.items}}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <!-- Placeholder image -->
                                                            <div class="ms-2">
                                                                {{#course}}
                                                                <h6 class="mb-0">{{title}}</h6>
                                                                <small class="text-muted">Curso Online</small>
                                                                {{/course}}
                                                                {{#event}}
                                                                <h6 class="mb-0">{{title}}</h6>
                                                                <small class="text-muted">Evento Presencial</small>
                                                                {{/event}}
                                                                {{#isSubscription}}
                                                                <h6 class="mb-0">Suscripción Premium</h6>
                                                                <small class="text-muted">Acceso Mensual</small>
                                                                {{/isSubscription}}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        1 <!-- Cantidad fija por ahora para cursos/eventos -->
                                                    </td>
                                                    <td class="text-end">
                                                        {{priceInEuros}}€
                                                    </td>
                                                    <td class="text-end">
                                                        <form action="/cart/remove/{{id}}" method="post" class="d-inline">
                                                            <input type="hidden" name="_csrf" value="{{_csrf.token}}" />
                                                            <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {{/order.items}}
                                                {{^order.items}}
                                                <tr>
                                                    <td colspan="4" class="text-center py-4">Tu carrito está vacío.</td>
                                                </tr>
                                                {{/order.items}}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <!-- Order Summary -->
                            <div class="card shadow-sm">
                                <div class="card-header bg-white py-3">
                                    <h5 class="mb-0">Resumen</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush mb-3">
                                        <li class="list-group-item d-flex justify-content-between border-0 px-0 pb-0">
                                            Subtotal
                                            <span>{{subtotal}}€</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between border-0 px-0">
                                            Impuestos (21%)
                                            <span>{{tax}}€</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between border-0 px-0 mb-3">
                                            <strong>Total</strong>
                                            <strong>{{total}}€</strong>
                                        </li>
                                    </ul>

                                    <!-- Pay Button -->
                                    <div class="d-grid gap-2">
                                        <button
                                            class="btn btn-primary btn-lg"
                                            type="button"
                                            style="background-color: #d96d3c; border-color: #d96d3c"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#paymentForm"
                                            aria-expanded="false"
                                            aria-controls="paymentForm"
                                            {{^order.items}}disabled{{/order.items}}>
                                            Pagar Ahora
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Form Container (Bootstrap Collapse) -->
                            <div class="collapse mt-4" id="paymentForm">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-white py-3">
                                        <h5 class="mb-0">Información de Tarjeta</h5>
                                    </div>
                                    <div class="card-body">
                                        <form action="/cart/checkout" method="post" id="checkoutForm" novalidate>
                                            <input type="hidden" name="_csrf" value="{{_csrf.token}}" />
                                            <div class="mb-3">
                                                <label for="cardName" class="form-label">Nombre en la tarjeta</label>
                                                <input type="text" class="form-control" id="cardName" name="cardName" required />
                                                <div class="invalid-feedback">Introduce el nombre del titular.</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="billingEmail" class="form-label">Email para factura</label>
                                                <input type="email" class="form-control" id="billingEmail" name="billingEmail" required />
                                                <div class="invalid-feedback">Introduce un email válido.</div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="cardNumber" class="form-label">Número de tarjeta</label>
                                                <input type="text" class="form-control" id="cardNumber" name="cardNumber" 
                                                       placeholder="0000 0000 0000 0000" maxlength="19" required />
                                                <div class="invalid-feedback">El número de tarjeta debe tener 16 dígitos.</div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6 mb-3">
                                                    <label for="cardExpiry" class="form-label">Caducidad (MM/YY)</label>
                                                    <input type="text" class="form-control" id="cardExpiry" name="cardExpiry" 
                                                           placeholder="MM/YY" maxlength="5" required />
                                                    <div class="invalid-feedback">Introduce una fecha válida (MM/YY) no expirada.</div>
                                                </div>
                                                <div class="col-6 mb-3">
                                                    <label for="cardCvv" class="form-label">CVV</label>
                                                    <input type="password" class="form-control" id="cardCvv" name="cardCvv"
                                                           maxlength="3" autocomplete="off" required />
                                                    <div class="invalid-feedback">El CVV debe tener 3 dígitos.</div>
                                                </div>
                                            </div>
                                            <div class="d-grid gap-2">
                                                <button type="submit" class="btn btn-success">Confirmar Pago</button>
                                            </div>
                                        </form>

                                        <script>
                                        (function() {
                                            const form = document.getElementById('checkoutForm');
                                            const cardNumber = document.getElementById('cardNumber');
                                            const cardExpiry = document.getElementById('cardExpiry');
                                            const cardCvv = document.getElementById('cardCvv');

                                            // Auto-format card number: 0000 0000 0000 0000
                                            cardNumber.addEventListener('input', function() {
                                                let v = this.value.replace(/\D/g, '').substring(0, 16);
                                                this.value = v.replace(/(.{4})/g, '$1 ').trim();
                                            });

                                            // Auto-format expiry: MM/YY
                                            cardExpiry.addEventListener('input', function() {
                                                let v = this.value.replace(/\D/g, '').substring(0, 4);
                                                if (v.length >= 3) {
                                                    v = v.substring(0, 2) + '/' + v.substring(2);
                                                }
                                                this.value = v;
                                            });

                                            // Only allow digits in CVV
                                            cardCvv.addEventListener('input', function() {
                                                this.value = this.value.replace(/\D/g, '').substring(0, 3);
                                            });

                                            // Validation on submit
                                            form.addEventListener('submit', function(e) {
                                                let valid = true;

                                                // Reset
                                                form.querySelectorAll('.form-control').forEach(function(el) {
                                                    el.classList.remove('is-invalid');
                                                });

                                                // Card name
                                                if (!document.getElementById('cardName').value.trim()) {
                                                    document.getElementById('cardName').classList.add('is-invalid');
                                                    valid = false;
                                                }

                                                // Email
                                                var email = document.getElementById('billingEmail');
                                                if (!email.value.trim() || !email.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                                                    email.classList.add('is-invalid');
                                                    valid = false;
                                                }

                                                // Card number: exactly 16 digits
                                                var digits = cardNumber.value.replace(/\D/g, '');
                                                if (digits.length !== 16) {
                                                    cardNumber.classList.add('is-invalid');
                                                    valid = false;
                                                }

                                                // Expiry: MM/YY format and not expired
                                                var expiryMatch = cardExpiry.value.match(/^(0[1-9]|1[0-2])\/(\d{2})$/);
                                                if (!expiryMatch) {
                                                    cardExpiry.classList.add('is-invalid');
                                                    valid = false;
                                                } else {
                                                    var expMonth = parseInt(expiryMatch[1], 10);
                                                    var expYear = 2000 + parseInt(expiryMatch[2], 10);
                                                    var now = new Date();
                                                    var currentMonth = now.getMonth() + 1;
                                                    var currentYear = now.getFullYear();
                                                    if (expYear < currentYear || (expYear === currentYear && expMonth < currentMonth)) {
                                                        cardExpiry.classList.add('is-invalid');
                                                        valid = false;
                                                    }
                                                }

                                                // CVV: exactly 3 digits
                                                if (!/^\d{3}$/.test(cardCvv.value)) {
                                                    cardCvv.classList.add('is-invalid');
                                                    valid = false;
                                                }

                                                if (!valid) {
                                                    e.preventDefault();
                                                }

                                                // Set clean card number (digits only) before submit
                                                if (valid) {
                                                    cardNumber.value = digits;
                                                }
                                            });
                                        })();
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        {{>footer}}
    </body>
</html>
