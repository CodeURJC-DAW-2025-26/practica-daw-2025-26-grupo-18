{{>header}}

<main class="main" id="profile-page-main">

	<!-- Page Title -->
	<div class="page-title light-background">
		<div class="container">
			<nav class="breadcrumbs">
				<ol>
					<li><a href="/">Inicio</a></li>
					<li class="current">Perfil</li>
				</ol>
			</nav>
			<h1>Perfil de estudiante</h1>
		</div>
	</div><!-- End Page Title -->

	<!-- Profile Overview -->
	<section class="section profile-overview-section">
		<div class="container" data-aos="fade-up">
			{{#errorMessage}}
			<div class="alert alert-warning mb-4" style="background-color: rgba(217, 109, 60, 0.15); color: #D96D3C; border: 1px solid #D96D3C;" role="alert">
				<i class="bi bi-exclamation-triangle-fill"></i> {{{errorMessage}}}
			</div>
			{{/errorMessage}}
			<div class="row g-4" id="profile-overview-row">
				<div class="col-lg-4" id="profile-main-container">
					<div class="card border-0 shadow-sm bg-light h-100">
						<div class="card-body p-4 text-center">
							<!-- Vista normal -->
							<div id="profile-view">
								<img src="/images/users/{{user.id}}/profile" alt="Foto de perfil" class="rounded-circle mb-3"
									width="120" height="120">
								<h3 class="h5 fw-bold mb-1">{{user.username}}</h3>
								<p class="text-muted mb-1">@{{user.username}}</p>
								<p class="text-muted mb-3">{{userType}}</p>
								<div class="course-tags justify-content-center">
									{{#userTags}}
									<span class="course-tag">{{.}}</span>
									{{/userTags}}
									{{^userTags}}
									<span class="text-muted small">Sin cursos suscritos</span>
									{{/userTags}}
								</div>
								<hr class="my-4">
								<div class="text-start">
									<p class="mb-2"><i class="bi bi-envelope me-2"></i> {{user.email}}</p>
									<p class="mb-2"><i class="bi bi-geo-alt me-2"></i> {{user.country}}</p>
									<p class="mb-0"><i class="bi bi-calendar-event me-2"></i> Miembro desde 2024</p>
								</div>
							</div>

							{{#isProfileOwner}}
							<!-- Vista edición -->
							<div id="profile-edit" style="display: none;">
								<form action="/profile/{{user.id}}/edit" method="post" enctype="multipart/form-data" class="needs-validation profile-edit-form" novalidate>
									<input type="hidden" name="_csrf" value="{{_csrf.token}}" />
									<div class="text-start mb-3">
										<h4 class="h6 fw-bold mb-1">Editar perfil</h4>
										<p class="text-muted small mb-0">Actualiza tus datos para que tu perfil destaque más.</p>
									</div>

									<!-- Imagen de perfil -->
									<div class="mb-3">
										<img id="preview-img" src="/images/users/{{user.id}}/profile" alt="Foto de perfil" class="rounded-circle mb-2"
											width="120" height="120">
										<div>
											<label for="imageFile" class="form-label small text-muted">Cambiar imagen</label>
											<input type="file" class="form-control form-control-sm" id="imageFile" name="imageFile" accept="image/*"
												onchange="previewImage(event)">
										</div>
									</div>

									<!-- Username -->
									<div class="mb-3 text-start">
										<label for="username" class="form-label fw-semibold"><i class="bi bi-person me-2"></i>Nombre de usuario</label>
										<input type="text" class="form-control" id="username" name="username" value="{{user.username}}" required>
										<div class="invalid-feedback">El nombre de usuario es obligatorio.</div>
									</div>

									<!-- Email -->
									<div class="mb-3 text-start">
										<label for="email" class="form-label fw-semibold"><i class="bi bi-envelope me-2"></i>Email</label>
										<input type="email" class="form-control" id="email" name="email" value="{{user.email}}" required>
										<div class="invalid-feedback">Por favor preste un correo electrónico válido.</div>
									</div>

									<!-- País -->
									<div class="mb-3 text-start">
										<label for="country" class="form-label fw-semibold"><i class="bi bi-geo-alt me-2"></i>País</label>
										<input type="text" class="form-control" id="country" name="country" value="{{user.country}}">
									</div>

									<!-- Descripción -->
									<div class="mb-3 text-start">
										<label for="shortDescription" class="form-label fw-semibold"><i class="bi bi-card-text me-2"></i>Sobre mí</label>
										<textarea class="form-control" id="shortDescription" name="shortDescription" rows="3" placeholder="Cuéntanos algo sobre ti...">{{#user}}{{shortDescription}}{{/user}}</textarea>
									</div>

									<!-- Objetivo actual -->
									<div class="mb-3 text-start">
										<label for="currentGoal" class="form-label fw-semibold"><i class="bi bi-briefcase me-2"></i>Objetivo actual</label>
										<input type="text" class="form-control" id="currentGoal" name="currentGoal" value="{{#user}}{{currentGoal}}{{/user}}" placeholder="Ej: Lanzar mi startup en 2026">
									</div>

									<!-- Rutina semanal -->
									<div class="mb-3 text-start">
										<label for="weeklyRoutine" class="form-label fw-semibold"><i class="bi bi-lightning me-2"></i>Rutina semanal</label>
										<input type="text" class="form-control" id="weeklyRoutine" name="weeklyRoutine" value="{{#user}}{{weeklyRoutine}}{{/user}}" placeholder="Ej: 6h de formación y 2h networking">
									</div>

									<!-- Comunidad -->
									<div class="mb-3 text-start">
										<label for="comunity" class="form-label fw-semibold"><i class="bi bi-people me-2"></i>Comunidad</label>
										<input type="text" class="form-control" id="comunity" name="comunity" value="{{#user}}{{comunity}}{{/user}}" placeholder="Ej: SCAM Builders · Madrid">
									</div>

									<div class="d-flex gap-2 justify-content-center mt-3">
										<button type="submit" class="btn btn-accent">Guardar cambios</button>
										<button type="button" class="btn btn-accent-outline" onclick="toggleEdit()">Cancelar</button>
									</div>
								</form>
							</div>
							{{/isProfileOwner}}
						</div>
					</div>
				</div>

				<div class="col-lg-8" id="profile-about-container">
					<div class="card border-0 shadow-sm bg-light h-100">
						<div class="card-body p-4">
							<h3 class="h5 fw-bold mb-3">Sobre mi</h3>
							<p class="text-muted">{{#user.shortDescription}}{{user.shortDescription}}{{/user.shortDescription}}{{^user.shortDescription}}Todavía no se ha añadido ninguna información.{{/user.shortDescription}}</p>
							<div class="row g-3">
								<div class="col-md-6">
									<div class="d-flex align-items-center gap-3">
										<i class="bi bi-briefcase fs-4 text-accent"></i>
										<div>
											<p class="mb-1 fw-semibold">Objetivo actual</p>
											<p class="mb-0 text-muted">{{#user.currentGoal}}{{user.currentGoal}}{{/user.currentGoal}}{{^user.currentGoal}}Todavía no se ha añadido ninguna información.{{/user.currentGoal}}</p>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="d-flex align-items-center gap-3">
										<i class="bi bi-lightning fs-4 text-accent"></i>
										<div>
											<p class="mb-1 fw-semibold">Rutina semanal</p>
											<p class="mb-0 text-muted">{{#user.weeklyRoutine}}{{user.weeklyRoutine}}{{/user.weeklyRoutine}}{{^user.weeklyRoutine}}Todavía no se ha añadido ninguna información.{{/user.weeklyRoutine}}</p>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="d-flex align-items-center gap-3">
										<i class="bi bi-people fs-4 text-accent"></i>
										<div>
											<p class="mb-1 fw-semibold">Comunidad</p>
											<p class="mb-0 text-muted">{{#user.comunity}}{{user.comunity}}{{/user.comunity}}{{^user.comunity}}Todavía no se ha añadido ninguna información.{{/user.comunity}}</p>
										</div>
									</div>
								</div>
								<div class="col-md-6">
									<div class="d-flex align-items-center gap-3">
										<i class="bi bi-award fs-4 text-accent"></i>
										<div>
											<p class="mb-1 fw-semibold">Certificaciones</p>
											<p class="mb-0 text-muted">{{completedCourses}} completadas</p>
										</div>
									</div>
								</div>
							</div>
							{{#isProfileOwner}}
							<div class="d-flex flex-wrap gap-2 mt-4">
								<a href="#" class="btn btn-accent" onclick="toggleEdit(); return false;">Editar perfil</a>
								<a href="#" class="btn btn-accent-outline">Gestionar suscripcion</a>
							</div>
							{{/isProfileOwner}}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>

	{{#isProfileOwner}}
	<!-- Progress Cards -->
	<section id="features-cards" class="features-cards section profile-stats-section">
		<div class="container" data-aos="fade-up" data-aos-delay="100">
			<div class="row g-4">
				<div class="col-lg-4" data-aos="flip-left" data-aos-delay="100">
					<div class="feature-card">
						<div class="icon-badge">
							<div class="icon-box icon-box-compact">
								<i class="bi bi-journal-text"></i>
							</div>
							<span class="badge status-badge">ACTIVO</span>
						</div>
						<h3>Cursos en progreso</h3>
						<p>Actualmente estas avanzando en {{inProgressCount}} cursos. Total inscritos: {{totalEnrollments}}.</p>
						<div class="course-progress">
							<small class="course-progress-label">Progreso global: {{averageProgress}}%</small>
							<div class="course-progress-bar">
								<div class="course-progress-fill" style="width: {{averageProgress}}%;"></div>
							</div>
						</div>
						<ul class="feature-list">
							<li><i class="bi bi-check-circle"></i> {{completedCourses}} cursos completados</li>
							<li><i class="bi bi-hourglass-split"></i> {{inProgressCount}} cursos en progreso</li>
						</ul>
						<div class="text-center mt-3 profile-stats-chart-frame profile-stats-chart-frame--tall">
							<iframe src="/statistics/course-progress?userId={{user.id}}"
								width="100%" height="100%" style="border:none; overflow:hidden;" scrolling="no"></iframe>
						</div>
					</div>
				</div>

				<div class="col-lg-4" data-aos="flip-left" data-aos-delay="200">
					<div class="feature-card">
						<div class="icon-badge">
							<div class="icon-box icon-box-compact">
								<i class="bi bi-clock-history"></i>
							</div>
							<span class="badge status-badge">CONSTANCIA</span>
						</div>
						<h3>Lecciones aprendidas</h3>
						<p>Has completado {{totalLessonsCompleted}} lecciones en total.</p>
						<!-- Lessons Chart -->
						<div class="text-center mt-3 mb-3 profile-stats-chart-frame">
							<iframe src="/statistics/lessons-learned?userId={{user.id}}"
								width="100%" height="100%" style="border:none; overflow:hidden;" scrolling="no"></iframe>
						</div>

						<ul class="feature-list">
							<li><i class="bi bi-check-circle"></i> {{completedLessonsThisMonth}} lecciones este mes</li>
							<li><i class="bi bi-check-circle"></i> {{averageLessonsPerMonth}} lecciones/mes (promedio)</li>
						</ul>
					</div>
				</div>

				<div class="col-lg-4" data-aos="flip-left" data-aos-delay="300">
					<div class="feature-card">
						<div class="icon-badge">
							<div class="icon-box icon-box-compact">
								<i class="bi bi-award"></i>
							</div>
							<span class="badge status-badge">LOGROS</span>
						</div>
						<h3>Certificados</h3>
						<p>{{completedCourses}} certificados completados y {{inProgressCount}} cursos en progreso.</p>
						<ul class="feature-list">
							{{#completedCourseNames}}
							<li><i class="bi bi-check-circle"></i> {{.}}</li>
							{{/completedCourseNames}}
							{{^completedCourseNames}}
							<li class="text-muted"><i class="bi bi-info-circle"></i> Aun no has completado ningun curso</li>
							{{/completedCourseNames}}
						</ul>
					</div>
				</div>
			</div>
		</div>
	</section>

	{{#isPublisher}}
	<!-- Instructor Panel (Role >= 2) -->
	<section class="section bg-light instructor-panel-section">
		<div class="container" data-aos="fade-up">
			<div class="section-title section-title-compact">
				<h2>Panel de Instructor</h2>
				<p>Gestiona tus cursos creados y visualiza el progreso de tus estudiantes.</p>
			</div>

			<div class="row g-4">
				<!-- Created Courses Carousel Area -->
				<div class="col-lg-8">
					<div id="instructorCoursesCarousel" class="carousel slide h-100 instructor-carousel" data-bs-ride="false">
						<div class="carousel-inner h-100">
							{{#createdCourses}}
							<div class="carousel-item {{#-first}}active{{/-first}} h-100">
								<div class="card border-0 shadow-sm h-100 instructor-course-card instructor-course-card-modern">
									<div class="card-body p-4">
										<div class="d-flex justify-content-between align-items-center mb-3">
											<h4 class="h5 fw-bold mb-0 text-truncate instructor-course-title" title="{{title}}">{{title}}</h4>
											{{#status}}
											<span class="badge bg-success">{{status}}</span>
											{{/status}}
											{{^status}}
											<span class="badge bg-secondary">Borrador</span>
											{{/status}}
										</div>
										<div class="row align-items-center">
											<div class="col-md-5">
												<div class="mb-3">
													<p class="text-muted small mb-1"><i class="bi bi-people me-1"></i> Total de usuarios suscritos: <span class="fw-semibold text-dark">{{totalSubscribers}}</span></p>
													<p class="text-muted small mb-0"><i class="bi bi-person-plus me-1"></i> Usuarios suscritos este mes: <span class="fw-semibold text-dark">{{monthlySubscribers}}</span></p>
												</div>
												<a href="/courses/{{id}}/manage" class="btn btn-sm btn-accent mt-2">Gestionar curso</a>
											</div>
											<div class="col-md-7 text-center">
												<div class="instructor-chart-frame">
													<iframe src="/statistics/created-course-status?courseId={{id}}" title="Estadísticas del curso"></iframe>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							{{/createdCourses}}
							
							{{^createdCourses}}
							<div class="carousel-item active h-100">
								<div class="card border-0 shadow-sm h-100">
									<div class="card-body p-4 d-flex align-items-center justify-content-center">
										<div class="text-center text-muted">
											<p class="mb-0">Aún no has creado ningún curso.</p>
										</div>
									</div>
								</div>
							</div>
							{{/createdCourses}}
						</div>
						
						{{#hasMultipleCourses}}
						<button class="carousel-control-prev instructor-carousel-control" type="button" data-bs-target="#instructorCoursesCarousel" data-bs-slide="prev">
							<span class="carousel-control-prev-icon" aria-hidden="true"></span>
							<span class="visually-hidden">Anterior</span>
						</button>
						<button class="carousel-control-next instructor-carousel-control" type="button" data-bs-target="#instructorCoursesCarousel" data-bs-slide="next">
							<span class="carousel-control-next-icon" aria-hidden="true"></span>
							<span class="visually-hidden">Siguiente</span>
						</button>
						{{/hasMultipleCourses}}
					</div>
				</div>

				<!-- Create New Course Button -->
				<div class="col-lg-4">
					<div class="card border-0 shadow-sm h-100 instructor-create-card">
						<div class="card-body p-4 d-flex align-items-center justify-content-center border-dashed instructor-create-card-body">
							<div class="text-center py-4">
								<div class="icon-box mb-3 mx-auto text-muted">
									<i class="bi bi-plus-lg fs-1"></i>
								</div>
								<h5 class="fw-bold text-muted">Crear nuevo curso</h5>
								<a href="/courses/new" class="stretched-link"></a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	{{/isPublisher}}

	<!-- Courses List -->
	<section class="courses-catalog section">
		<div class="container" data-aos="fade-up">
			<div class="section-title section-title-compact">
				<h2>Mis cursos suscritos</h2>
				<p>Continua donde lo dejaste y completa tus rutas activas.</p>
			</div>

			<div class="course-list">
				{{#subscribedCourses}}
				<article class="course-card-full" data-aos="fade-up">
					<div class="course-card-header">
						<div>
							<h3 class="course-card-title">{{title}}</h3>
							<div class="course-tags">
								{{#tags}}
								<span class="course-tag">{{.}}</span>
								{{/tags}}
							</div>
						</div>
						<div class="course-card-price">
							{{#isCompleted}}
							<span class="badge bg-success">Completado · 100%</span>
							{{/isCompleted}}
							{{^isCompleted}}
							<span class="badge" style="background-color: var(--accent-color); color: #fff;">En curso · {{progress}}%</span>
							{{/isCompleted}}
						</div>
					</div>
					<p class="course-card-desc">{{description}}</p>
					<div class="course-card-meta">
						<div><i class="bi bi-person"></i> {{creatorName}}</div>
					</div>
					<div class="course-progress mt-3">
						<small class="course-progress-label">Avance actual</small>
						<div class="course-progress-bar" style="height: 10px;">
							<div class="course-progress-fill" data-progress="{{progress}}"></div>
						</div>
					</div>
					<div class="course-card-actions">
						<a href="/course/{{courseId}}" class="btn btn-sm btn-accent-outline course-card-btn">Ver detalles</a>
					</div>
				</article>
				{{/subscribedCourses}}
				{{^subscribedCourses}}
				<p class="text-muted text-center">No estas suscrito a ningun curso todavia.</p>
				{{/subscribedCourses}}
			</div>
		</div>
	</section>

	<!-- Upcoming Events -->
	<section class="section">
		<div class="container" data-aos="fade-up">
			<div class="section-title section-title-compact">
				<h2>Eventos guardados</h2>
				<p>Actividades que has marcado para ampliar tu red profesional.</p>
			</div>
			<div class="list-group">
				{{#userEvents}}
				<a href="/event/{{eventId}}"
					class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
					<div>
						<h6 class="mb-1">{{title}}</h6>
						<small class="text-muted"><i class="bi bi-geo-alt me-1"></i> {{locationLabel}}</small>
					</div>
					<span class="badge bg-light text-dark border">{{startDate}}</span>
				</a>
				{{/userEvents}}
				{{^userEvents}}
				<p class="text-muted text-center">No tienes eventos guardados.</p>
				{{/userEvents}}
			</div>
		</div>
	</section>
	{{/isProfileOwner}}

</main>

{{>footer}}

<script>
{{#errorMessage}}
document.addEventListener('DOMContentLoaded', function() {
	setProfileEditMode(true);
});
{{/errorMessage}}

function setProfileEditMode(isEditing) {
	var main = document.getElementById('profile-page-main');
	var view = document.getElementById('profile-view');
	var edit = document.getElementById('profile-edit');
	var about = document.getElementById('profile-about-container');
	var mainContainer = document.getElementById('profile-main-container');

	if (!view || !edit) return;

	if (isEditing) {
		view.style.display = 'none';
		edit.style.display = 'block';
		if (about) about.style.display = 'none';
		if (mainContainer) {
			mainContainer.classList.remove('col-lg-4');
			mainContainer.classList.add('col-12', 'is-editing');
		}
		if (main) {
			main.classList.add('profile-edit-mode');
		}
	} else {
		view.style.display = 'block';
		edit.style.display = 'none';
		if (about) about.style.display = 'block';
		if (mainContainer) {
			mainContainer.classList.remove('col-12', 'is-editing');
			mainContainer.classList.add('col-lg-4');
		}
		if (main) {
			main.classList.remove('profile-edit-mode');
		}
	}
}

function toggleEdit() {
	var view = document.getElementById('profile-view');
	if (view.style.display === 'none') {
		setProfileEditMode(false);
	} else {
		setProfileEditMode(true);
	}
}

function previewImage(event) {
	var reader = new FileReader();
	reader.onload = function() {
		document.getElementById('preview-img').src = reader.result;
	};
	reader.readAsDataURL(event.target.files[0]);
}

document.querySelectorAll('.course-progress-fill[data-progress]').forEach(function (bar) {
	var value = parseInt(bar.getAttribute('data-progress'), 10);
	if (isNaN(value)) value = 0;
	value = Math.max(0, Math.min(100, value));
	bar.style.width = value + '%';
});

(function () {
	'use strict'
	var forms = document.querySelectorAll('.needs-validation')
	Array.prototype.slice.call(forms)
		.forEach(function (form) {
			form.addEventListener('submit', function (event) {
				if (!form.checkValidity()) {
					event.preventDefault()
					event.stopPropagation()
				}
				form.classList.add('was-validated')
			}, false)
		})
})()
</script>

</body>

</html>